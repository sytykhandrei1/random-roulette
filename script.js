class RouletteApp {
    constructor() {
        this.participants = [];
        // nextSpinPenalty —Ö—Ä–∞–Ω–∏—Ç —à—Ç—Ä–∞—Ñ—ã (–º—É–ª—å—Ç–∏–ø–ª–∏–∫–∞—Ç–æ—Ä—ã –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏) –Ω–∞ –°–õ–ï–î–£–Æ–©–ò–ô —Å–ø–∏–Ω
        // –ø—Ä–∏–º–µ—Ä: { "–ò–≤–∞–Ω": 0.5 } ‚Äî –≤ —Å–ª–µ–¥—É—é—â–µ–º —Å–ø–∏–Ω–µ —à–∞–Ω—Å –≤ 2 —Ä–∞–∑–∞ –º–µ–Ω—å—à–µ
        this.nextSpinPenalty = new Map();
        this.stats = new Map(); // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–±–µ–¥
        this.allTimeParticipants = new Set(); // –î–ª—è —Å–∞–¥–∂–µ—Å—Ç–æ–≤
        this.maxParticipants = 30;
        // –≠–º–æ–¥–∑–∏-–∞–≤–∞—Ç–∞—Ä—ã —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        this.avatars = new Map();
        
        this.initializeElements();
        this.loadData();
        this.setupEventListeners();
        this.updateUI();
    }

    initializeElements() {
        this.contextInput = document.getElementById('context');
        this.participantInput = document.getElementById('participant-input');
        this.addButton = document.getElementById('add-participant');
        this.suggestionsDiv = document.getElementById('suggestions');
        this.participantsList = document.getElementById('participants-list');
        this.spinDurationInput = document.getElementById('spin-duration');
        this.spinButton = document.getElementById('spin-button');
        this.resultSection = document.getElementById('result-section');
        this.winnerDisplay = document.getElementById('winner-display');
        this.confettiContainer = document.getElementById('confetti-container');
        this.statsContent = document.getElementById('stats-content');
        this.resetStatsButton = document.getElementById('reset-stats');
        this.carouselTrack = document.getElementById('carousel-track');
    }

    setupEventListeners() {
        this.addButton.addEventListener('click', () => this.addParticipant());
        this.participantInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.addParticipant();
        });
        this.participantInput.addEventListener('input', () => this.showSuggestions());
        this.spinButton.addEventListener('click', () => this.spinRoulette());
        this.resetStatsButton.addEventListener('click', () => this.resetStats());
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–∞–¥–∂–µ—Å—Ç–æ–≤ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.suggestions') && !e.target.closest('#participant-input')) {
                this.hideSuggestions();
            }
        });
    }

    addParticipant() {
        const name = this.participantInput.value.trim();
        
        if (!name) {
            alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è —É—á–∞—Å—Ç–Ω–∏–∫–∞');
            return;
        }
        
        if (this.participants.length >= this.maxParticipants) {
            alert(`–ú–∞–∫—Å–∏–º—É–º ${this.maxParticipants} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`);
            return;
        }
        
        if (this.participants.includes(name)) {
            alert('–≠—Ç–æ—Ç —É—á–∞—Å—Ç–Ω–∏–∫ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω');
            return;
        }
        
        this.participants.push(name);
        // –ù–∞–∑–Ω–∞—á–∞–µ–º —ç–º–æ–¥–∑–∏-–∞–≤–∞—Ç–∞—Ä –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏
        if (!this.avatars.has(name)) {
            this.avatars.set(name, this.generateRandomEmoji());
        }
        this.allTimeParticipants.add(name);
        this.participantInput.value = '';
        this.hideSuggestions();
        this.updateUI();
        this.saveData();
    }

    removeParticipant(name) {
        this.participants = this.participants.filter(p => p !== name);
        this.updateUI();
        this.saveData();
    }

    showSuggestions() {
        const query = this.participantInput.value.trim().toLowerCase();
        
        if (query.length < 1) {
            this.hideSuggestions();
            return;
        }
        
        const suggestions = Array.from(this.allTimeParticipants)
            .filter(name => name.toLowerCase().includes(query) && !this.participants.includes(name))
            .slice(0, 5);
        
        if (suggestions.length === 0) {
            this.hideSuggestions();
            return;
        }
        
        this.suggestionsDiv.innerHTML = suggestions
            .map(name => `<div class="suggestion-item" data-name="${name}">${name}</div>`)
            .join('');
        
        this.suggestionsDiv.style.display = 'block';
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤ –Ω–∞ —Å–∞–¥–∂–µ—Å—Ç—ã
        this.suggestionsDiv.querySelectorAll('.suggestion-item').forEach(item => {
            item.addEventListener('click', () => {
                this.participantInput.value = item.dataset.name;
                this.hideSuggestions();
            });
        });
    }

    hideSuggestions() {
        this.suggestionsDiv.style.display = 'none';
    }

    updateUI() {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏
        const totalWins = Array.from(this.stats.values()).reduce((sum, wins) => sum + wins, 0);
        this.participantsList.innerHTML = this.participants.map(name => {
            const wins = this.stats.get(name) || 0;
            const percentage = totalWins > 0 ? ((wins / totalWins) * 100).toFixed(0) : 0;
            const avatar = this.avatars.get(name) || 'üôÇ';
            const hasTotem = this.nextSpinPenalty.has(name) && (this.nextSpinPenalty.get(name) < 1);
            return `
                <div class="participant-card">
                    <div class="participant-avatar" aria-hidden="true">${avatar}</div>
                    <div class="participant-info">
                        <div class="participant-name">${name}</div>
                        <div class="participant-stats">${percentage}% –ø–æ–±–µ–¥</div>
                    </div>
                    <div class="participant-actions">
                        <div class="totem ${hasTotem ? 'active' : ''}" title="–¢–æ—Ç–µ–º: ‚àí50% —à–∞–Ω—Å–∞ –≤ —Å–ª–µ–¥—É—é—â–∏–π —Å–ø–∏–Ω"></div>
                        <button class="remove" onclick="app.removeParticipant('${name}')" aria-label="–£–¥–∞–ª–∏—Ç—å">√ó</button>
                    </div>
                </div>
            `;
        }).join('');

        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—É—Å–µ–ª—å
        if (this.carouselTrack) {
            const items = this.participants.length ? this.participants : ['üê∞','ü¶ä','üê±','üê®','üê∂','üêµ'];
            const row = [];
            const avatars = items.map(n => (this.avatars.get(n) || n));
            const sequence = [...avatars, 'CENTER', ...avatars];
            this.carouselTrack.innerHTML = sequence.map(token => {
                if (token === 'CENTER') return `<div class="carousel-item large">${avatars[0] || 'üê∞'}</div>`;
                return `<div class="carousel-item">${token}</div>`;
            }).join('');
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–ø—É—Å–∫–∞
        this.spinButton.disabled = this.participants.length < 2;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        this.updateStats();
    }

    updateStats() {
        if (this.stats.size === 0) {
            this.statsContent.innerHTML = '<p>–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
            return;
        }
        
        const totalWins = Array.from(this.stats.values()).reduce((sum, wins) => sum + wins, 0);
        
        const statsHTML = Array.from(this.stats.entries())
            .sort((a, b) => b[1] - a[1])
            .map(([name, wins]) => {
                const percentage = totalWins > 0 ? ((wins / totalWins) * 100).toFixed(1) : 0;
                return `
                    <div class="stat-item">
                        <span class="stat-name">${name}</span>
                        <div class="stat-values">
                            <span>–ü–æ–±–µ–¥: ${wins}</span>
                            <span>–ü—Ä–æ—Ü–µ–Ω—Ç: ${percentage}%</span>
                        </div>
                    </div>
                `;
            }).join('');
        
        this.statsContent.innerHTML = statsHTML;
    }

    spinRoulette() {
        if (this.participants.length < 2) return;
        
        this.spinButton.disabled = true;
        this.resultSection.classList.add('hidden');
        
        // –°–æ–∑–¥–∞–µ–º —Ä—É–ª–µ—Ç–∫—É
        this.createRoulette();
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
        const duration = parseInt(this.spinDurationInput.value) * 1000;
        setTimeout(() => {
            this.selectWinner();
        }, duration);
    }

    createRoulette() {
        // –ê–Ω–∏–º–∞—Ü–∏—è –∫–∞—Ä—É—Å–µ–ª–∏: —Å–º–µ—â–∞–µ–º —Ç—Ä–µ–∫ –≤–ª–µ–≤–æ –Ω–∞ —Å–ª—É—á–∞–π–Ω—É—é –¥–∏—Å—Ç–∞–Ω—Ü–∏—é –∏ easing
        if (!this.carouselTrack || this.participants.length < 2) return;
        const durationMs = parseInt(this.spinDurationInput.value) * 1000;
        const itemWidth = 150 + 16; // 150px + gap
        const bigWidth = 212 + 16;
        const baseOffset = -(itemWidth * 3 + bigWidth / 2); // –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ç–∞–∫, —á—Ç–æ–±—ã –∫—Ä—É–ø–Ω—ã–π —Ü–µ–Ω—Ç—Ä –æ–∫–∞–∑–∞–ª—Å—è –ø–æ–¥ —É–∫–∞–∑–∞—Ç–µ–ª–µ–º

        // –°—Ç—Ä–æ–∏–º –ø—É–ª —Å —É—á–µ—Ç–æ–º —à—Ç—Ä–∞—Ñ–æ–≤
        const weighted = [];
        this.participants.forEach(name => {
            const factor = this.nextSpinPenalty.get(name) || 1;
            const tickets = Math.max(1, Math.round(10 * factor));
            for (let i = 0; i < tickets; i++) weighted.push(name);
        });
        const winner = weighted[Math.floor(Math.random() * weighted.length)];

        // –ù–∞–π–¥–µ–º –∏–Ω–¥–µ–∫—Å –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –≤ —Ç–µ–∫—É—â–µ–º –º–∞—Å—Å–∏–≤–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        const index = Math.max(0, this.participants.indexOf(winner));
        const targetShift = baseOffset - index * itemWidth;

        this.carouselTrack.style.transition = 'none';
        this.carouselTrack.style.transform = `translateY(-50%) translateX(0px)`;
        // –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º —Ç–∏–∫–µ
        requestAnimationFrame(() => {
            this.carouselTrack.style.transition = `transform ${durationMs}ms cubic-bezier(.12,.64,.16,1)`;
            this.carouselTrack.style.transform = `translateY(-50%) translateX(${targetShift}px)`;
        });
    }

    selectWinner() {
        // –í—ã–±–∏—Ä–∞–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è —Å —É—á–µ—Ç–æ–º —à—Ç—Ä–∞—Ñ–æ–≤ (—Ç–∞ –∂–µ –ª–æ–≥–∏–∫–∞, —á—Ç–æ –≤ createRoulette)
        const weightedParticipants = [];
        this.participants.forEach(name => {
            const factor = this.nextSpinPenalty.get(name) || 1;
            const tickets = Math.max(1, Math.round(10 * factor));
            for (let i = 0; i < tickets; i++) weightedParticipants.push(name);
        });
        const randomIndex = Math.floor(Math.random() * weightedParticipants.length);
        const winner = weightedParticipants[randomIndex];
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        this.stats.set(winner, (this.stats.get(winner) || 0) + 1);
        
        // –ù–∞–∑–Ω–∞—á–∞–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—é —à—Ç—Ä–∞—Ñ –Ω–∞ –°–õ–ï–î–£–Æ–©–ò–ô —Å–ø–∏–Ω: —à–∞–Ω—Å √ó0.5
        this.nextSpinPenalty.set(winner, 0.5);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        this.showResult(winner);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º UI, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–æ—Ç–µ–º —É –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
        this.updateUI();
        
        this.spinButton.disabled = false;
        this.saveData();
    }

    showResult(winner) {
        const context = this.contextInput.value.trim();
        const resultText = context ? `${winner}, ${context}` : winner;
        
        this.winnerDisplay.textContent = resultText;
        this.resultSection.classList.remove('hidden');
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ñ–µ—Ç—Ç–∏
        this.createConfetti();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        this.updateStats();
    }

    createConfetti() {
        const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3'];
        
        for (let i = 0; i < 50; i++) {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.cssText = `
                left: ${Math.random() * 100}%;
                background: ${colors[Math.floor(Math.random() * colors.length)]};
                animation-delay: ${Math.random() * 3}s;
                animation-duration: ${3 + Math.random() * 2}s;
            `;
            
            this.confettiContainer.appendChild(confetti);
            
            // –£–¥–∞–ª—è–µ–º –∫–æ–Ω—Ñ–µ—Ç—Ç–∏ –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
            setTimeout(() => {
                if (confetti.parentNode) {
                    confetti.parentNode.removeChild(confetti);
                }
            }, 5000);
        }
    }

    resetStats() {
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É?')) {
            this.stats.clear();
            this.winnerWeights.clear();
            this.updateStats();
            this.saveData();
        }
    }

    saveData() {
        const data = {
            participants: this.participants,
            allTimeParticipants: Array.from(this.allTimeParticipants),
            stats: Array.from(this.stats.entries()),
            context: this.contextInput.value,
            avatars: Array.from(this.avatars.entries()),
            penalties: Array.from(this.nextSpinPenalty.entries())
        };
        localStorage.setItem('rouletteData', JSON.stringify(data));
    }

    loadData() {
        const data = localStorage.getItem('rouletteData');
        if (data) {
            try {
                const parsed = JSON.parse(data);
                this.participants = parsed.participants || [];
                this.allTimeParticipants = new Set(parsed.allTimeParticipants || []);
                this.stats = new Map(parsed.stats || []);
                this.contextInput.value = parsed.context || '';
                this.avatars = new Map(parsed.avatars || []);
                this.nextSpinPenalty = new Map(parsed.penalties || []);
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', e);
            }
        }
    }

    generateRandomEmoji() {
        const pool = ['üê∂','üê±','üê≠','üêπ','üê∞','ü¶ä','üêª','üêº','üê®','üêØ','ü¶Å','üê∑','üê∏','üêµ','ü¶Ñ','üêî','üêß','üê¶','üê§'];
        return pool[Math.floor(Math.random() * pool.length)];
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
const app = new RouletteApp();
